generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// üîπ USUARIOS DEL SISTEMA
//////////////////////////////////////////////////////
model User {
  id           Int           @id @default(autoincrement())
  username     String        @unique
  password     String
  email        String?       @unique
  role         String        @default("OPERADOR") // ADMIN | OPERADOR | CONSULTA
  avatarPath   String?
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  Convocations Convocation[] @relation("UserConvocations")
}

//////////////////////////////////////////////////////
// üîπ √ÅREAS DE TRABAJO
//////////////////////////////////////////////////////
model Area {
  id                  Int                   @id @default(autoincrement())
  nombre              String
  descripcion         String?
  active              Boolean               @default(true)
  Empleados           Employee[]
  ConvocationAssigned ConvocationEmployee[] @relation("AreaAssigned")
}

//////////////////////////////////////////////////////
// üîπ EMPLEADOS
//////////////////////////////////////////////////////
model Employee {
  id            Int                   @id @default(autoincrement())
  cedula        String                @unique
  nombres       String
  apellidos     String
  email         String?
  telefono      String?
  direccion     String?
  cargo         String?
  fechaIngreso  DateTime?
  estado        String                @default("ACTIVO") // ACTIVO | INACTIVO
  notas         String?
  createdAt     DateTime              @default(now())
  areaId        Int
  area          Area                  @relation(fields: [areaId], references: [id])
  Penalties     Penalty[]
  Convocations  ConvocationEmployee[]
  Attendance    Attendance[]
  AttendanceRec AttendanceRecord[] // üÜï relaci√≥n con asistencias por convocatoria
}

//////////////////////////////////////////////////////
// üîπ CONVOCATORIAS
//////////////////////////////////////////////////////
model Convocation {
  id           Int                   @id @default(autoincrement())
  titulo       String
  descripcion  String?
  fechaTrabajo DateTime
  estado       String                @default("BORRADOR") // BORRADOR | ENVIADA | CERRADA
  creadoPorId  Int
  creadoPor    User                  @relation("UserConvocations", fields: [creadoPorId], references: [id])
  createdAt    DateTime              @default(now())
  Employees    ConvocationEmployee[]
  Attendance   AttendanceRecord[] // üÜï relaci√≥n con registros de asistencia
}

//////////////////////////////////////////////////////
// üîπ RELACI√ìN ENTRE EMPLEADO Y CONVOCATORIA
//////////////////////////////////////////////////////
model ConvocationEmployee {
  id             Int         @id @default(autoincrement())
  convocationId  Int
  convocation    Convocation @relation(fields: [convocationId], references: [id])
  employeeId     Int
  employee       Employee    @relation(fields: [employeeId], references: [id])
  estado         String      @default("CONVOCADO") // CONVOCADO | CONFIRMADO | ASISTIO | NO_ASISTIO | JUSTIFICADO
  comentario     String?
  assignedAreaId Int?
  assignedArea   Area?       @relation("AreaAssigned", fields: [assignedAreaId], references: [id])
  updatedAt      DateTime    @updatedAt

  @@unique([convocationId, employeeId])
}

//////////////////////////////////////////////////////
// üîπ PENALIZACIONES
//////////////////////////////////////////////////////
model Penalty {
  id            Int      @id @default(autoincrement())
  employeeId    Int
  employee      Employee @relation(fields: [employeeId], references: [id])
  motivo        String
  fechaInicio   DateTime
  fechaFin      DateTime
  origen        String   @default("AUTO") // AUTO | MANUAL
  activo        Boolean  @default(true)
  registradoPor Int?
  createdAt     DateTime @default(now())
}

//////////////////////////////////////////////////////
// üîπ PAR√ÅMETROS GENERALES DEL SISTEMA
//////////////////////////////////////////////////////
model Param {
  clave String @id
  valor String
}

//////////////////////////////////////////////////////
// üîπ REGISTRO DE AUDITOR√çA
//////////////////////////////////////////////////////
model AuditLog {
  id          Int      @id @default(autoincrement())
  actorUserId Int?
  accion      String
  entidad     String
  entidadId   Int?
  payloadJson String?
  createdAt   DateTime @default(now())
}

//////////////////////////////////////////////////////
// üîπ ASISTENCIA GENERAL (fuera de convocatorias)
//////////////////////////////////////////////////////
model Attendance {
  id          Int       @id @default(autoincrement())
  employee    Employee  @relation(fields: [employeeId], references: [id])
  employeeId  Int
  fecha       DateTime
  horaEntrada DateTime?
  horaSalida  DateTime?
  createdAt   DateTime  @default(now())

  @@unique([employeeId, fecha])
}

//////////////////////////////////////////////////////
// üîπ ASISTENCIA POR CONVOCATORIA (nueva)
//////////////////////////////////////////////////////
model AttendanceRecord {
  id            Int       @id @default(autoincrement())
  employeeId    Int
  convocationId Int
  fecha         DateTime
  horaEntrada   DateTime?
  horaSalida    DateTime?
  estado        String    @default("FALT√ì") // ASISTI√ì | FALT√ì | JUSTIFICADO
  comentario    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  employee    Employee    @relation(fields: [employeeId], references: [id])
  convocation Convocation @relation(fields: [convocationId], references: [id])

  @@unique([employeeId, convocationId])
  @@index([convocationId])
}
